# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

TakeoutFix is a Go CLI tool that restores metadata (capture date, GPS location, description) to Google Photos media files exported via Google Takeout. It runs as an interactive terminal wizard that extracts ZIP archives, pairs media files with their companion JSON metadata files, and uses `exiftool` to apply the metadata back onto the media.

## Build & Development Commands

```bash
make check          # Default: fmt-check + vet + test + build
make check-all      # check + race tests + lint + goreleaser check
make fmt            # Auto-format all Go files
make test           # Run all tests
make test-race      # Run tests with race detector
make build          # Build binary: ./takeoutfix
make lint           # Run golangci-lint (skipped if not installed)

# Run a single test
go test ./internal/preflight/ -run TestCheckDiskSpace

# Run the built binary
./takeoutfix --workdir /path/to/folder
```

## Architecture

### Pipeline Stages

The wizard (`internal/wizard/flow.go`) orchestrates a sequential pipeline:

1. **Dependency check** (`internal/preflight/deps.go`) — finds `exiftool` in PATH; offers auto-install per platform
2. **ZIP discovery** (`internal/preflight/zipcheck.go`) — finds `.zip` files in the working directory
3. **ZIP validation** (`internal/preflight/zipcheck.go`) — parallel integrity check across all CPU cores
4. **Disk space check** (`internal/preflight/disk.go`) — estimates required space; offers "delete mode" (removes ZIPs after extraction) if tight
5. **State load** (`internal/state/state.go`) — loads `.takeoutfix/state.json` to skip already-extracted archives on re-runs (fingerprint = size:modtime)
6. **Extraction** (`internal/extract/zip.go`) — extracts to `takeoutfix-extracted/`; saves state after each archive
7. **Metadata processing** (`internal/processor/processor.go`) — parallel per-file processing:
   - `utils/extensions/` — queries exiftool for correct `FileTypeExtension`, renames if mismatched
   - `utils/metadata/` — applies JSON metadata to media via exiftool (EXIF dates, GPS coords, title/description)
   - `utils/files/` — recursive scan that pairs media files with their companion JSON files

### Key Patterns

- **Dependency injection via package-level vars** — `internal/wizard/flow.go` declares `var checkDependencies = preflight.CheckDependencies` etc. Tests override these vars to inject mocks without any framework.
- **exiftool session pooling** — `internal/exiftool/session.go` keeps a single `exiftool -stay_open True` process alive across many files for performance, with fallback to per-file invocation on error.
- **Platform-specific files** — `disk_unix.go` / `disk_windows.go` use build tags for OS-specific disk space queries via `golang.org/x/sys`.

### Package Layout

- `main.go` — entry point, `--workdir` flag parsing
- `internal/wizard/` — orchestration flow, terminal I/O helpers, final report
- `internal/preflight/` — pre-processing: dependency checks, ZIP validation, disk space
- `internal/extract/` — ZIP extraction with path-traversal protection
- `internal/processor/` — parallel metadata processing coordinator
- `internal/state/` — persistent state for re-run support
- `internal/exiftool/` — interactive exiftool process session management
- `internal/exifcmd/` — exiftool binary resolution
- `internal/patharg/` — safe path escaping for exiftool arguments
- `utils/files/` — recursive Takeout directory scanning and media-JSON pairing
- `utils/extensions/` — file extension detection and correction
- `utils/metadata/` — exiftool command building for metadata application

### Exit Codes

- `0` — success
- `2` — preflight failure (missing deps, corrupt ZIPs, no space)
- `3` — runtime failure

## Dependencies

Only one external Go module: `golang.org/x/sys` for platform disk-space syscalls. Everything else is stdlib. Runtime requires `exiftool` on PATH.

## Release

GoReleaser builds cross-platform binaries (linux/darwin/windows, amd64/arm64). Tags follow `YYYY.MM.N` format and are auto-generated by the `auto-tag.yml` workflow on merge to main.