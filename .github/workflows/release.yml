name: release

on:
  push:
    tags:
      - "*.*.*"

permissions:
  contents: write

jobs:
  goreleaser:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate tag format
        shell: bash
        run: |
          TAG="${GITHUB_REF_NAME}"
          if [[ ! "$TAG" =~ ^[0-9]{4}\.(0[1-9]|1[0-2])\.[0-9]+$ ]]; then
            echo "Invalid tag format: '$TAG'"
            echo "Expected: YYYY.MM.N (example: 2026.02.1)"
            exit 1
          fi

      - name: Ensure tag points to main HEAD
        shell: bash
        run: |
          git fetch origin main --depth=1
          TAG_COMMIT="$(git rev-list -n 1 "$GITHUB_REF")"
          MAIN_HEAD="$(git rev-parse origin/main)"

          if [[ "$TAG_COMMIT" != "$MAIN_HEAD" ]]; then
            echo "Release tags must point to current main HEAD."
            echo "tag commit:  $TAG_COMMIT"
            echo "main commit: $MAIN_HEAD"
            exit 1
          fi

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod

      - name: Run tests
        run: go test ./...

      - name: GoReleaser release
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: "~> v2"
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
